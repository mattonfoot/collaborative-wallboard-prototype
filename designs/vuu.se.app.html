<!DOCTYPE HTML>
<html>
  <head>
    <title>VUU.SE UI Prototype</title>
    
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <!-- Bootstrap -->
    <link href="./css/vendor/bootstrap.min.css" rel="stylesheet" media="screen">
    <link href="./css/vendor/bootstrap-theme.min.css" rel="stylesheet" media="screen">
    
    <style>
      .tab-content {
        width: 100%;
        height: 600px;
        border-bottom: 1px solid #ddd;
        background: #f9f9f9;
      }
    </style>
  </head>
  <body>
    <div id="app">
      <ul class="nav nav-tabs">
        <li><button type="button" class="btn btn-default add-board" title="Add Board"><i class="glyphicon glyphicon-plus"></i></button></li>
      </ul>

      <div class="tab-content"></div>
      
      <nav class="navbar navbar-default navbar-fixed-bottom" role="navigation">
        <button type="button" class="btn btn-default add-region" disabled title="Create Region"><i class="glyphicon glyphicon-plus"></i> New Region</button>
        <button type="button" class="btn btn-default add-pocket" disabled title="Create Card"><i class="glyphicon glyphicon-plus"></i> New Card</button>
      </nav>
    </div>    
    
    <script src="./lib/vendor/jquery1.10.2.min.js"></script>
    <script src="./lib/vendor/bootstrap.min.js"></script>    
    <script src="./lib/vendor/kinetic-v4.6.0.min.js"></script>
    <script src="/socket.io/socket.io.js"></script>
    
    <script src="./lib/vuu.se.eventqueue.js"></script>
    
    <script src="./lib/vuu.se.wall.js"></script>
    <script src="./lib/vuu.se.board.js"></script>
    <script src="./lib/vuu.se.pocket.js"></script>
    <script src="./lib/vuu.se.card.js"></script>
    <script src="./lib/vuu.se.region.js"></script>
    
    <script src="./lib/shapes/vuu.se.canvas.board.js"></script>
    <script src="./lib/shapes/vuu.se.canvas.card.js"></script>
    <script src="./lib/shapes/vuu.se.canvas.region.js"></script>
    
    <script defer="defer">
    
  
  // emits:  
  
  // triggers:  app:initend, board:add, region:add, pocket:add, wall:clone, app:initbegin
  
  // on (socket):  app:init --> app:initbegin
  
  // on (queue):  app:initbegin --> wall:clone, board:cloned --> [board:activated], board:createend --> [board:activated], wall:createend --> app:initend, wall:boardadded


    
    
    
    
  
// namespace
  
var vuu = { se: {} };
    
// event queue setup
  
var socket = io.connect('http://localhost:5000'),
    queue = new EventQueue( { debug: true } ),
    app = { element: $('#app'), wall: {} };
    
    
    
    
  // triggers

socket.on( 'app:init', initializeApplication);





  // handlers


function initializeApplication( resources ) {
  var data = resources[0]; // for now we only do one wall in the whole thing
  var controlsEnabled = false;
  
  app.size = {
    width: app.element.find('.tab-content').outerWidth(),
    height: app.element.find('.tab-content').outerHeight()
  };
  
    // triggers

  queue.on( app, 'app:initbegin', triggerAddWall );
  
  queue.on( app, 'wall:cloned', completeApp);

  queue.on( app, 'wall:boardadded', enableBoardControls );
    
  app.element.delegate( 'a[data-toggle="tab"]', 'shown.bs.tab', activateBoard );
  
  // add board control

  app.element.delegate( '.add-board', 'mouseup touchend', triggerAddBoard );

  queue.on( app, 'app:createboard', function( data ) {
    socket.emit( 'board:create', data );
  });
    
  socket.on( 'board:created', function( data ) { 
    queue.trigger( app, 'board:create', data );
  });
    
  socket.on( 'board:clone', function( data ) { 
    queue.trigger( app, 'board:clone', data );
  });
  
  socket.on( 'board:createfail', function( data ) {
    alert( 'board:createfail' );
  });
  
  queue.on( app, 'board:cloned', addTab );
  
  queue.on( app, 'board:created', addTab );

  function triggerAddBoard( ev ) {  
    var key = prompt( 'Please provide a data key that this board represents', '' );
    
    var data = { wall: app.wall, key: key };
    
    queue.trigger( app, 'app:createboard', data );
  }
  
  // add region control

  app.element.delegate( '.add-region', 'mouseup touchend', triggerAddRegion );

  queue.on( app, 'app:createregion', function( data ) {
    socket.emit( 'region:create', data );
  });

  queue.on( app, 'region:moved', function( data ) {
    socket.emit( 'region:moved', data );
  });

  queue.on( app, 'region:resized', function( data ) {
    socket.emit( 'region:resized', data );
  });
  
  socket.on( 'region:created', function( data ) {
    queue.trigger( app, 'region:create', data );
  });
  
  socket.on( 'region:clone', function( data ) {
    queue.trigger( app, 'region:clone', { region: data } );
  });
  
  socket.on( 'region:updated', function( data ) {
    queue.trigger( app, 'region:updated', data );
  });
  
  socket.on( 'region:createfail', function( data ) {
    alert( 'region:createfail' );
  });

  function triggerAddRegion( ev ) {  
    var board = app.wall.getActiveBoard();
    
    var val = prompt( 'Please provide a value for this region', '' );
    
    var data = {
      x: 10,
      y: 10,
      width: 250,
      height: 150,
      board: board,
      value: val
    };
    
    queue.trigger( app, 'app:createregion', data );
  }
  
  // add pocket control

  app.element.delegate( '.add-pocket', 'mouseup touchend', triggerAddPocket );

  queue.on( app, 'app:createpocket', function( data ) {
    socket.emit( 'pocket:create', data );
  });
  
  socket.on( 'pocket:created', function( data ) {
    queue.trigger( app, 'pocket:create', data );
  });  
  
  socket.on( 'pocket:clone', function( data ) {
    queue.trigger( app, 'pocket:clone', data );
  });
  
  socket.on( 'pocket:createfail', function( data ) {
    alert( 'pocket:createfail' );
  });
  
  queue.on( app.wall, 'pocket:created', function ( data ) {
    var pocket = data.pocket;
    
    app.wall.links.boards.forEach(function( board ) {
      queue.trigger( app, 'app:createcard', { board: board, pocket: pocket } );
    });
  });

  queue.on( app.wall, 'pocket:cloned', function ( data ) {
    var pocket = data.pocket;
    
    app.wall.links.boards.forEach(function( board ) {  
      $.get('/pockets/' + pocket.id + '/cards/', function( resources ) {
        resources.cards.forEach(function( card ) {    
          if ( card.links.board == board.id ) {
            queue.trigger( app, 'app:clonecard', card );
          }
        });
      });
    });
  });

  function triggerAddPocket( ev ) {  
    var title = prompt( 'Please provide a title for this card', 'Sample Card' );
    
    queue.trigger( app.wall, 'app:createpocket', { wall: app.wall, title: title } );
  }
  
  // add card control

  queue.on( app, 'app:createcard', function( data ) {
    socket.emit( 'card:create', data );
  });

  queue.on( app, 'card:moved', function( data ) {
    socket.emit( 'card:moved', data );
  });

  queue.on( app, 'card:tagged', function( data ) {
    socket.emit( 'card:tagged', data );
  });

  queue.on( app, 'card:untagged', function( data ) {
    socket.emit( 'card:untagged', data );
  });
  
  socket.on( 'card:created', function( data ) {
    queue.trigger( app, 'card:create', data );
  });
  
  socket.on( 'card:clone', function( data ) {
    queue.trigger( app, 'card:clone', data );
  });
  
  socket.on( 'card:updated', function( data ) {
    queue.trigger( app, 'card:updated', data );
  });

  queue.on( app, 'app:clonecard', function( data ) {
    queue.trigger( app, 'card:clone', data );
  });
  
  socket.on( 'card:createfail', function( data ) {
    alert( 'card:createfail' );
  });
  
  
  // handlers
    
  function addTab( data ) {  
    app.element.find( 'li.active' ).removeClass('active');
    
    var id = data.board.id;
    
    $( '<li class="active"><a href="#'+ id +'" data-toggle="tab">' + data.board.getKey() + '</a></li>' ).insertBefore( app.element.find( '.add-board' ).parent() );
    
    app.wall.setActiveBoardById( id );
  }
    
  function completeApp( wall ) {
    app.element.data('wall', wall);
  
    queue.trigger( app, 'app:initend', { app: app } );
  }
  
  function activateBoard(e) {
    var hash = e.target.hash;
    var boardid = hash.substr( 1, hash.length - 1 );
    
    app.wall.setActiveBoardById( boardid );
  }

  function triggerAddWall( data ) {
    queue.trigger( app, 'wall:clone', data.wall );
  }
      
  function enableBoardControls() {
    if ( !controlsEnabled ) {
      app.element.find('.add-pocket, .add-region').removeAttr( 'disabled' );
      controlsEnabled = true;
    }
  }

  queue.trigger( app, 'app:initbegin', { app: app, wall: data } );
}




    
    
  // emits:  
  
  // triggers:  board:clone, pocket:clone, wall:cloned
  
  // on (socket):  
  
  // on (queue):  wall:clone


    
  // triggers

queue.on( app, 'wall:clone', cloneWall );





  // handlers
    
function cloneWall( data ) {
  data.links = data.links || {};
    
  app.wall = new Wall( queue, data );
  
  console.log( app.wall );
  
  var boards = data.links.boards || [];
  boards.forEach( function( id ) {
    $.get('/boards/' + id, function( data ) {
      if ( data.boards && data.boards[0] ) {
        queue.trigger( app.wall, 'board:clone', data.boards[0] );
      }
    });
  });
  
  
  var pockets = data.links.pockets || [];
  pockets.forEach( function( id ) {
    $.get('/pockets/' + id, function( data ) {
      if ( data.pockets && data.pockets[0] ) {
        queue.trigger( app.wall, 'pocket:clone', data.pockets[0] );
      }
    });
  });

  queue.trigger( app.wall, 'wall:cloned', { wall: app.wall } );
}



  
  
  // triggers
  
  

  queue.on( app, 'canvascard:opened', function( data ) {
    var pocket = data.pocket;
    var data = pocket.getData();
    var html = '';
    
    for ( var key in data ) {
      html += '<tr><th>'+ key + '</th><td>' + data[ key ] + '</td></tr>';
    }
    
    $('<div class="modal fade"> \
  <div class="modal-dialog"> \
    <div class="modal-content"> \
      <div class="modal-header"> \
        <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button> \
        <h4 class="modal-title">[#' + pocket.cardnumber + '] ' + pocket.title + '</h4> \
      </div> \
      <div class="modal-body"><table class="table"><thead><tr><th>Key</th><th>Value</th></tr></thead><tbody>' + html + '</tbody></table></div> \
      <div class="modal-footer"> \
        <button type="button" class="btn btn-default" data-dismiss="modal">Close</button> \
      </div> \
    </div> \
  </div> \
</div>').appendTo('body').modal('show');
  });
  
  
  
  



/*

initialize app - done

get current state from server
  wall - done
    boards
      cards
      regions
    pockets
    
--------
    
initialize UI remote façades - done
initialize UI - done

add a board to the wall - done
  add a shelf to the board  --  no shelf currently they just appear top left of each board
  
add a card to the shelf --  adds straight to the baord for now
  move a card onto the board --  adds straight to the baord

add a region to the board - done
  resize a region
  move a region - done -- should this check all the cards to see if any cards are now within its bounds ??

move a card over a region - done
  detect a collision between a region and card - done
  modify the card data - 
  
--------
  
  
server should return existing card from data store if one is already stored for a specific pocket and board combination =- done
  
add two different regions to two different boards - done
  delete a region
  resize a region
  color the background of a region if it is a valid color value - done
  edit region value
  regions display the value in a title position
  
predefined list of board name based on registered plugins
  edit board name
  
gender plugin
  predefined values if board is of a specific name
  region value validation based on board name
  color the background of a region based on its chosen predefined value
  
card tagging logic to allow plugins to create a tag shape 
  card to work out the best way to display a tag
  multiple predefined anchors to group tags around
  
cards are considered inside a region if they more than 50% of them is over it - done

card is over two or more regions on the same board - done (issue with tagging that will be resolved by card working out way to display tags)

display pocket data when double clicking card

server needs to update hypermedia rather than just pass message on - done

db backup
  
  
-----
  
ui triggers create event
  --> server creates model created event
    --> UI creates remote façade --- because cards trigger off pockets both clients create a card so we get duplicates - fixed
      --> UI creates element

*/
    </script>
    <script src="./lib/commands/vuu.se.board.create.js"></script>
    <script src="./lib/commands/vuu.se.pocket.create.js"></script>
    <script src="./lib/commands/vuu.se.card.create.js"></script>
    <script src="./lib/commands/vuu.se.region.create.js"></script>
    <script src="./lib/commands/vuu.se.card.trackmovement.js"></script>
    <script src="./lib/vuu.se.plugins.js"></script>
    <script src="./lib/vuu.se.plugins.displayColorTag.js"></script>
  </body>
</html>